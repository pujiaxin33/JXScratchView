# JXScratchView
ä¸€ä¸ªä¸‡èƒ½çš„åˆ®åˆ®ä¹æ§ä»¶ã€‚æ— è®ºæ˜¯UILabelã€UIImageViewï¼Œè¿˜æ˜¯è‡ªå®šä¹‰è§†å›¾ï¼Œåªè¦æ˜¯UIViewéƒ½å¯ä»¥ç”¨æ¥åˆ®ã€‚ä»£ç ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä½ å€¼å¾—æ‹¥æœ‰ï¼

![å½©ç¥¨åˆ®åˆ®ä¹.png](https://upload-images.jianshu.io/upload_images/1085173-3873a79943af2d26.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# å‰è¨€
è¿™æ˜¯ä¸€ä¸ªç®€å•å´åŠŸèƒ½å¼ºå¤§çš„åˆ®åˆ®ä¹è§†å›¾ï¼Œå‡ è¡Œä»£ç å°±å¯ä»¥å®ç°åˆ®åˆ®ä¹æ•ˆæœï¼Œè€Œä¸”æ€§èƒ½è‰¯å¥½ã€‚ä¸‹é¢æœ‰ç¾å¥³ç¦åˆ©å“Ÿï¼Œç›¸ä¿¡æˆ‘ï¼Œä½ ä¼šå–œæ¬¢çš„ğŸ˜ğŸ˜

ç›¸ä¿¡å¤§å®¶éƒ½ä¹°è¿‡å½©ç¥¨åˆ®åˆ®ä¹ï¼Œæ€»æ˜¯ä¼šæŠ±ç€ä¸­å¤§å¥–çš„æƒ…å†µå»åˆ®ï¼Œå¸Œæœ›è‡ªå·±æ˜¯æœ€å¹¸è¿çš„é‚£ä¸€ä¸ªï¼Œåˆ®ä¸­äº”ç™¾ä¸‡ï¼ŒæŠ±å¾—ç¾äººå½’ï¼Œä»æ­¤èµ°ä¸Šäººç”Ÿå·…å³°ã€‚ä½†ç°å®å¾€å¾€æ˜¯ä½ å£è¢‹é‡Œé¢çš„å‡ åå—é›¶é’±ï¼Œå‡ åˆ†é’Ÿå°±è¢«æ¶ˆè´¹æ®†å°½äº†ğŸ˜‚
è®¸å¤šAPPä¹Ÿé›†æˆäº†è¿™ä¸€åŠŸèƒ½ï¼Œæ¯”å¦‚ç”¨æ”¯ä»˜å®çº¿ä¸‹æ”¯ä»˜åå°±æœ‰åˆ®åˆ®ä¹ã€‚è™½ç„¶åˆ®ä¸­çš„éƒ½æ˜¯äº›æ²¡å¤šå¤§ç”¨çš„ä¼˜æƒ åˆ¸ï¼Œä½†æ€»æ˜¯ä¼šå¸å¼•äººå»åˆ®ä¸€åˆ®ï¼Œä¸‡ä¸€ä¸­äº†å¤§å¥–å‘¢ğŸ˜

# å®ç°æ•ˆæœ
å¤šè¯´æ— ç›Šï¼Œå…ˆæ¥çœ‹çœ‹å®ç°çš„æ•ˆæœå§

## å½©ç¥¨åˆ®åˆ®ä¹
![å½©ç¥¨åˆ®åˆ®ä¹.gif](https://upload-images.jianshu.io/upload_images/1085173-fdbdc50c422e771a.gif?imageMogr2/auto-orient/strip)


## ç¾å¥³åˆ®åˆ®ä¹
![ç¾å¥³åˆ®åˆ®ä¹.gif](https://upload-images.jianshu.io/upload_images/1085173-1cf693ff93b33ff8.gif?imageMogr2/auto-orient/strip)

å‚ç…§äº†ä¸€ä¸ªå«åšâ€œæ’•æ‰å¥¹çš„è¡£æœâ€APPï¼Œæ•ˆæœéå¸¸sexyï¼Œæœ‰æ²¡æœ‰ä¸€ç§å¿ƒè·³åŠ å¿«ï¼Œè¡€è„‰è†¨èƒ€çš„æ„Ÿè§‰ã€‚ï¼ˆç›¸ä¿¡å¤§å®¶è¿«ä¸åŠå¾…æƒ³è¦ä½“éªŒä¸€ä¸‹äº†ï¼Œç‚¹å‡»[https://fir.im/JXScratchView](https://fir.im/JXScratchView)ï¼Œé€šè¿‡safariæ‰“å¼€è¯¥é“¾æ¥ï¼Œå®‰è£…ä¹‹åä¿¡ä»»è¯ä¹¦ï¼Œå°±å¯ä»¥å¿«é€Ÿä½“éªŒäº†ï¼‰**ç›¸ä¿¡æˆ‘åœ¨ç©ºç™½å¤„ï¼ŒåŒå‡»ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°æ–°å¤§é™†ğŸ˜**

# è°ƒç ”
åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ç•ªï¼Œæ–¹æ¡ˆåŸºæœ¬ä¸Šå°±æ˜¯è¿™ç§ï¼š[é“¾æ¥](https://www.jianshu.com/p/7c2042764e0c)ã€‚
æ ¸å¿ƒä»£ç ï¼š
```objc
-(void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
    
    // è§¦æ‘¸ä»»æ„ä½ç½®
    UITouch *touch = touches.anyObject;
    // è§¦æ‘¸ä½ç½®åœ¨å›¾ç‰‡ä¸Šçš„åæ ‡
    CGPoint cententPoint = [touch locationInView:self.imageView];
    // è®¾ç½®æ¸…é™¤ç‚¹çš„å¤§å°
    CGRect  rect = CGRectMake(cententPoint.x, cententPoint.y, 20, 20);
    // é»˜è®¤æ˜¯å»åˆ›å»ºä¸€ä¸ªé€æ˜çš„è§†å›¾
    UIGraphicsBeginImageContextWithOptions(self.imageView.bounds.size, NO, 0);
    // è·å–ä¸Šä¸‹æ–‡(ç”»æ¿)
    CGContextRef ref = UIGraphicsGetCurrentContext();
    // æŠŠimageViewçš„layeræ˜ å°„åˆ°ä¸Šä¸‹æ–‡ä¸­
    [self.imageView.layer renderInContext:ref];
    // æ¸…é™¤åˆ’è¿‡çš„åŒºåŸŸ
    CGContextClearRect(ref, rect);
    // è·å–å›¾ç‰‡
    UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
    // ç»“æŸå›¾ç‰‡çš„ç”»æ¿, (æ„å‘³ç€å›¾ç‰‡åœ¨ä¸Šä¸‹æ–‡ä¸­æ¶ˆå¤±)
    UIGraphicsEndImageContext();
    
    self.imageView.image = image;
}
```
ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š
1ã€ç”»ç¬”æ˜¯çŸ©å½¢çš„ï¼Œçœ‹ç€å¾ˆéš¾å—ï¼›
2ã€ç»˜ç”»çš„æ ¸å¿ƒä»£ç ç”¨äº†CoreGraphicsï¼Œæ¯æ¬¡ç§»åŠ¨éƒ½è¦é‡æ–°å¼€å¯ä¸€ä¸ªcontextä¸Šä¸‹æ–‡ï¼Œç»˜åˆ¶imageï¼Œå¯¹CPUçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„æ¶ˆè€—ã€‚[ç‚¹å‡»è¯¥é“¾æ¥ï¼Œè¯¦ç»†äº†è§£CAShapeLayeræ¯”CGçš„ä¼˜åŠ¿](https://zsisme.gitbooks.io/ios-/content/chapter6/cashapelayer.html)
æ‰€ä»¥ï¼Œæˆ‘æƒ³äº†ä¸€ä¸ªéªšæŠ€å·§ï¼Œç”¨CAShapeLayerä½œä¸ºmaskæ¥å®ç°è¯¥æ•ˆæœã€‚[ç‚¹å‡»è¯¥é“¾æ¥ï¼Œäº†è§£maskå›¾å±‚é®ç½©](https://zsisme.gitbooks.io/ios-/content/chapter4/layer-masking.html)

# åŸç†
![å›¾å±‚è§£é‡Š.png](https://upload-images.jianshu.io/upload_images/1085173-9e0a0ddb897f7db4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
å¦‚å›¾æ‰€ç¤ºï¼Œåªè¦ç”¨æˆ·æ»‘åŠ¨çš„æ—¶å€™ï¼Œæ›´æ–°contentViewçš„maskLayerçš„pathï¼Œå°±å¯ä»¥å®ç°åˆ®åˆ®ä¹çš„æ•ˆæœäº†ã€‚ä»£ç å¦‚ä¸‹ï¼š
- åˆå§‹åŒ–
```swift
/// æŒ‡å®šåˆå§‹åŒ–å™¨
    ///
    /// - Parameters:
    ///   - contentView: å†…å®¹è§†å›¾ï¼Œæ¯”å¦‚å½©ç¥¨çš„å¥–å“è¯¦æƒ…å†…å®¹ã€‚ï¼ˆéœ€è¦éšè—èµ·æ¥çš„å†…å®¹ï¼‰
    ///   - maskView: é®ç½©è§†å›¾
    public init(contentView: UIView, maskView: UIView) {
        super.init(frame: CGRect.zero)

        scratchMaskView = maskView
        self.addSubview(scratchMaskView)

        scratchContentView = contentView
        self.addSubview(scratchContentView)

        maskLayer = CAShapeLayer()
        maskLayer.strokeColor = UIColor.red.cgColor
        maskLayer.lineWidth = strokeLineWidth
        maskLayer.lineCap = strokeLineCap
        scratchContentView?.layer.mask = maskLayer

        maskPath = UIBezierPath()
    }
```
- ç»˜ç”»æ ¸å¿ƒä»£ç 
```swift
open override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
        guard let touch = touches.first else {
            return
        }
        let point = touch.location(in: scratchContentView)
        maskPath.move(to: point)
    }

    open override func touchesMoved(_ touches: Set<UITouch>, with event: UIEvent?) {
        guard let touch = touches.first else {
            return
        }
        let point = touch.location(in: scratchContentView)
        maskPath.addLine(to: point)
        maskPath.move(to: point)
        maskLayer.path = maskPath.cgPath
    }
```
- è·å–å·²ç»åˆ®äº†å¤šå°‘ç™¾åˆ†æ¯”ï¼Œæ¯”å¦‚ç”¨æˆ·åˆ®äº†70%çš„æ—¶å€™ï¼Œå°±æ˜¾ç¤ºå…¨éƒ¨ã€‚
```swift
//è·å–é€æ˜åƒç´ å æ€»åƒç´ çš„ç™¾åˆ†æ¯”
    private func getAlphaPixelPercent(img: UIImage) -> Float {
        //è®¡ç®—åƒç´ æ€»ä¸ªæ•°
        let width = Int(img.size.width)
        let height = Int(img.size.height)
        let bitmapByteCount = width * height

        //å¾—åˆ°æ‰€æœ‰åƒç´ æ•°æ®
        let pixelData = UnsafeMutablePointer<UInt8>.allocate(capacity: bitmapByteCount)
        let colorSpace = CGColorSpaceCreateDeviceGray()
        let context = CGContext(data: pixelData,
                                width: width,
                                height: height,
                                bitsPerComponent: 8,
                                bytesPerRow: width,
                                space: colorSpace,
                                bitmapInfo: CGBitmapInfo(rawValue:
                                    CGImageAlphaInfo.alphaOnly.rawValue).rawValue)!
        let rect = CGRect(x: 0, y: 0, width: width, height: height)
        context.clear(rect)
        context.draw(img.cgImage!, in: rect)


        //è®¡ç®—é€æ˜åƒç´ ä¸ªæ•°
        var alphaPixelCount = 0
        for x in 0...Int(width) {
            for y in 0...Int(height) {
                if pixelData[y * width + x] == 0 {
                    alphaPixelCount += 1
                }
            }
        }

        free(pixelData)

        return Float(alphaPixelCount) / Float(bitmapByteCount)
    }
    //å±•ç¤ºå…¨éƒ¨
    open func showContentView() {
        self.scratchContentView.layer.mask = nil
    }
```
# ä½¿ç”¨
- å½©ç¥¨åˆ®åˆ®ä¹ç¤ºä¾‹ä»£ç 
```swift
        let contentView = UILabel()
        contentView.backgroundColor = UIColor.white
        contentView.textAlignment = .center
        contentView.font = UIFont.systemFont(ofSize: 25)
        contentView.text = "æ­å–œä½ åˆ®ä¸­500ä¸‡"
        contentView.numberOfLines = 0

        let maskView = UIView()
        maskView.backgroundColor = UIColor.lightGray

        let ratio = self.bounds.size.width/400
        scratchView = JXScratchView(contentView: contentView, maskView: maskView)
        scratchView.delegate = self
        scratchView.strokeLineWidth = 25
        scratchView.strokeLineCap = kCALineCapRound
        scratchView.frame = CGRect(x: 33*ratio, y: 140*ratio, width: 337*ratio, height: 154*ratio)
        addSubview(scratchView)
```
- æŒ‡å®šä½¿ç”¨JXScratchViewçš„`public init(contentView: UIView, maskView: UIView)`åˆå§‹åŒ–å™¨ï¼Œåªéœ€è¦ä¼ å…¥UIViewåŠå…¶å­ç±»å°±å¯ä»¥äº†ã€‚
- `strokeLineCap`å±æ€§è®¾ç½®strokeå½¢çŠ¶ï¼Œé»˜è®¤`kCALineCapRound`
- `strokeLineWidth`å±æ€§è®¾ç½®strokeçº¿å®½ï¼Œé»˜è®¤20
- éµä»`JXScratchViewDelegate`ï¼Œå®ç°`func scratchView(scratchView: JXScratchView, didScratched percent: Float)`ä»£ç†æ–¹æ³•ï¼Œå°±å¯ä»¥å®æ—¶è·å–åˆ®åˆ®ä¹çš„ç™¾åˆ†æ¯”ã€‚
- å»ºè®®æ–°å»ºä¸€ä¸ªUIViewï¼ŒæŠŠJXScratchViewå°è£…è¿›å»ï¼Œå¯ä»¥å‚è€ƒ`JXScratchTicketView`

# Githubä»“åº“åœ°å€
[ä»“åº“åœ°å€ï¼Œå–œæ¬¢å°±starä¸€ä¸‹â¤ï¸](https://github.com/pujiaxin33/JXScratchView) 
